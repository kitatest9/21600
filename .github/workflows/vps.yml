name: VPS_Ultimate_Stable
on:
  push:
  workflow_dispatch:

jobs:
  run-vps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      - name: Setup Tools & File Manager
        run: |
          sudo apt-get update && sudo apt-get install tmate curl wget tar -y
          
          # Filebrowser Official Installation (Fixed)
          curl -fsSL https://raw.githubusercontent.com | bash
          
          # Background mein Filebrowser start karein
          nohup filebrowser --noauth --address 0.0.0.0 --port 8080 --root . > /dev/null 2>&1 &

      - name: Main Loop & Recovery Logic
        run: |
          # --- Tmate Start Function ---
          start_tmate() {
            # Purana session saaf karein
            pkill -9 tmate || true
            rm -f /tmp/tmate.sock
            
            # Naya session
            tmate -S /tmp/tmate.sock new-session -d
            sleep 20 # Links generate hone ka wait
            
            SSH_LINK=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')
            WEB_LINK=$(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')
            
            # Discord Notification
            if [ ! -z "$SSH_LINK" ]; then
              curl -X POST -H "Content-Type: application/json" -d "{
                \"embeds\": [{
                  \"title\": \"ðŸš€ VPS Ready!\",
                  \"description\": \"Looping enabled. Auto-save every 5.5 hours.\",
                  \"color\": 3066993,
                  \"fields\": [
                    {\"name\": \"ðŸ’» SSH Access\", \"value\": \"\`$SSH_LINK\`\", \"inline\": false},
                    {\"name\": \"ðŸŒ Web Interface\", \"value\": \"$WEB_LINK\", \"inline\": false}
                  ]
                }]
              }" ${{ secrets.DISCORD_WEBHOOK }}
            fi
          }

          # Initial Start
          start_tmate

          # Crash Recovery Monitor (Background)
          (
            while true; do
              if ! pgrep -x "tmate" > /dev/null; then
                start_tmate
              fi
              sleep 60
            done
          ) &

          # --- Cycle Timer (5.5 Hours) ---
          sleep 20000

          # Auto-Save to GitHub
          git config --global user.name "VPS-Bot"
          git config --global user.email "bot@github.com"
          git add .
          git commit -m "Auto-save changes" || echo "Nothing to save"
          git push origin main

          # Self-Trigger Loop
          curl -X POST -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
          -H "Accept: application/vnd.github.v3+json" \
          https://api.github.com{{ github.repository }}/actions/workflows/vps.yml/dispatches \
          -d '{"ref":"main"}'
          
